print("Starting Tracking")
local UPDATE_INTERVAL = 45
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Fsys = require(ReplicatedStorage:WaitForChild("Fsys"))
local ClientData = Fsys.load("ClientData")

local SUPABASE_URL = "https://wcasmkanukpsuhidtwwy.supabase.co/rest/v1/bot_stats"
local API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjYXNta2FudWtwc3VoaWR0d3d5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTc4MjMsImV4cCI6MjA4Mzk5MzgyM30.WbUQ9vXUvM5Rd_FMQNa1Zr8E3jkBhVKLdxI-0f5k-4o"

local SESSION_START = os.date("!%Y-%m-%dT%H:%M:%SZ")
local function get_current_stats()
	local bucks = ClientData.get_server(LocalPlayer, "money")
	if not bucks or bucks == 0 then
		local rawData = ClientData.get_data()[LocalPlayer.Name]
		if rawData then bucks = rawData.money end
	end
	bucks = bucks or 0 

	local agePotionsCount = 0
	local data = ClientData.get_data()[LocalPlayer.Name]
	if data and data.inventory and data.inventory.food then
		for unique, d in pairs(data.inventory.food) do
			if d.id == "pet_age_potion" then
				agePotionsCount = agePotionsCount + 1
			end
		end
	end
	return bucks, agePotionsCount
end
local sB, sP = get_current_stats()
if not getgenv().StartBucks then getgenv().StartBucks = sB end
if not getgenv().StartPotions then getgenv().StartPotions = sP end

print("âœ… Tracker Started at: " .. SESSION_START)

while task.wait(UPDATE_INTERVAL) do
	local currentBucks, currentPotions = get_current_stats()
	local sBucks = getgenv().StartBucks
	local sPotions = getgenv().StartPotions

	local payload = {
		username = LocalPlayer.Name,
		start_bucks = sBucks,
		start_potions = sPotions,
		bucks_gained = currentBucks - sBucks,
		potions_gained = currentPotions - sPotions,
		note = Tracker.Note,
		session_start = SESSION_START
	}

	pcall(function()
		local requestFunc = request or http_request or (http and http.request) or (syn and syn.request)
		if not requestFunc then return end

		local cleanUrl = string.gsub(SUPABASE_URL, "%s+", "")
		requestFunc({
			Url = cleanUrl .. "?on_conflict=username", 
			Method = "POST",
			Headers = {
				["apikey"] = API_KEY,
				["Authorization"] = "Bearer " .. API_KEY,
				["Content-Type"] = "application/json",
				["Prefer"] = "resolution=merge-duplicates"
			},
			Body = HttpService:JSONEncode(payload)
		})
	end)
end
